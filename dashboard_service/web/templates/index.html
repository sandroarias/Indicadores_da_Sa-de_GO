{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Indicadores - Saúde GO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
    </style>
</head>
<body>
    
    <div class="hero-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h1 class="hero-title"><i class="bi bi-activity"></i> Portal de Indicadores - Saúde</h1>
                    <p class="hero-subtitle">Painel unificado de monitoramento e análise de indicadores de saúde pública do Estado de Goiás.</p>
                    
                    <div class="stats-banner">
                        <div class="stat-item">
                            <span class="number" id="total-count">0</span>
                            <span class="label">Indicadores</span>
                        </div>
                        <div class="stat-item">
                            <span class="number" id="categories-count">0</span>
                            <span class="label">Categorias</span>
                        </div>
                    </div>
                </div>
                </div>
        </div>
    </div>

    <div class="container">
        
        <div class="row justify-content-center search-container">
            <div class="col-lg-8">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="O que você está procurando? (Ex: Dengue, Saúde Mental...)">
                    <div class="search-icon"><i class="bi bi-search"></i></div>
                </div>
            </div>
        </div>

        <div id="indicatorsGrid" class="indicators-grid">
            </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="bi bi-clipboard-x"></i>
            <h3>Nenhum indicador encontrado</h3>
            <p>Tente buscar por outros termos ou verifique a ortografia.</p>
        </div>

    </div>

    <footer class="main-footer">
        <div class="container">
            <p>&copy; 2024 Secretaria de Estado da Saúde de Goiás - Superintendência de Tecnologia</p>
        </div>
    </footer>

    {{ indicators|json_script:"indicators-data" }}

    <script>
        
        let indicators = [];
        try {
            indicators = JSON.parse(document.getElementById('indicators-data').textContent);
        } catch (e) { console.error("Erro ao ler dados", e); }

        function getIconForCategory(category, title) {
            const text = (category + " " + title).toLowerCase();
            if (text.includes('mental') || text.includes('psico')) return 'bi-emoji-dizzy';
            if (text.includes('trabalho') || text.includes('ocupacional')) return 'bi-briefcase';
            if (text.includes('dengue') || text.includes('aedes')) return 'bi-bug';
            if (text.includes('vacina') || text.includes('imuno')) return 'bi-shield-check';
            if (text.includes('hospital') || text.includes('leito')) return 'bi-hospital';
            if (text.includes('mortalidade') || text.includes('obito')) return 'bi-heart-pulse';
            if (text.includes('vigilancia')) return 'bi-eye';
            return 'bi-bar-chart-fill';
        }

        function getCategoryColor(category) {
            
            if (!category) return 'background: #e3f2fd; color: #1976d2;';
            
            const colors = [
                { bg: '#e3f2fd', text: '#1976d2' }, // Azul
                { bg: '#e8f5e9', text: '#2e7d32' }, // Verde
                { bg: '#fff3e0', text: '#ef6c00' }, // Laranja
                { bg: '#f3e5f5', text: '#7b1fa2' }, // Roxo
                { bg: '#ffebee', text: '#c62828' }, // Vermelho
            ];
            
            let hash = 0;
            for (let i = 0; i < category.length; i++) hash = category.charCodeAt(i) + ((hash << 5) - hash);
            const index = Math.abs(hash) % colors.length;
            
            return `background: ${colors[index].bg}; color: ${colors[index].text};`;
        }

        function render(data) {
            const grid = document.getElementById('indicatorsGrid');
            const empty = document.getElementById('emptyState');
            
            
            document.getElementById('total-count').innerText = data.length;
            const uniqueCats = new Set(data.map(i => i.category || 'Geral'));
            document.getElementById('categories-count').innerText = uniqueCats.size;

            if (data.length === 0) {
                grid.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            empty.style.display = 'none';

            grid.innerHTML = data.map(item => {
                const iconClass = getIconForCategory(item.category || '', item.title || '');
                const catStyle = getCategoryColor(item.category || 'Geral');
                const categoryName = item.category || 'Geral';
                
                let displayTitle = item.title;
                if(displayTitle.startsWith('ind_')) displayTitle = "Indicador " + displayTitle.replace('ind_', '');

                return `
                <a href="/dashboard/${item.id}/" class="indicator-card">
                    <div class="card-header-flex">
                        <div class="card-icon">
                            <i class="bi ${iconClass}"></i>
                        </div>
                        <div class="card-content">
                            <span class="card-category" style="${catStyle}">${categoryName}</span>
                            <h3 class="card-title" title="${displayTitle}">${displayTitle}</h3>
                        </div>
                    </div>
                    
                    <p class="card-description">
                        ${item.description ? item.description.replace(/<[^>]*>?/gm, '') : 'Descrição não disponível.'}
                    </p>
                    
                    <div class="card-footer">
                        <span><i class="bi bi-folder2-open"></i> ${item.uid}</span>
                        <span><i class="bi bi-arrow-right-circle"></i> Acessar</span>
                    </div>
                </a>
                `;
            }).join('');
        }

        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = indicators.filter(item => 
                (item.title && item.title.toLowerCase().includes(term)) ||
                (item.description && item.description.toLowerCase().includes(term)) ||
                (item.category && item.category.toLowerCase().includes(term))
            );
            render(filtered);
        });

        render(indicators);

    </script>
</body>
</html>